<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Virtual IoT Lab DEI</title>
  <link rel="icon" href="https://www.vlab.co.in/images/logo.jpg" type="image/x-icon" />
  <link rel="stylesheet" type="text/css" href="src/css/style.css" />

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <link rel="stylesheet" href="./src/css/sidepanel.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

  <!-- for chart animation  -->
  <!-- Resources -->
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

  <!-- for gauge -->
  <!-- Resources -->
  <!-- <script src="https://cdn.amcharts.com/lib/5/index.js"></script> -->
  <!-- <script src="https://cdn.amcharts.com/lib/5/xy.js"></script> -->
  <script src="https://cdn.amcharts.com/lib/5/radar.js"></script>
  <!-- <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script> -->
  <link rel="stylesheet" href="./style.css">
</head>

<body>
  <script>
    $(document).ready(function () {
      $("#flip").click(function () {
        $("#textBox").slideToggle("slow");
      });
    });

    // let connect =()=>{
    //   alert("Connection Successfully....")
    // }


    //for chart

    am5.ready(function () {

      // Create root element
      // https://www.amcharts.com/docs/v5/getting-started/#Root_element
      var root = am5.Root.new("gaugediv");

      // Set themes
      // https://www.amcharts.com/docs/v5/concepts/themes/
      root.setThemes([
        am5themes_Animated.new(root)
      ]);

      // Create chart
      // https://www.amcharts.com/docs/v5/charts/radar-chart/
      var chart = root.container.children.push(
        am5radar.RadarChart.new(root, {
          panX: false,
          panY: false,
          startAngle: 180,
          endAngle: 360
        })
      );

      chart.getNumberFormatter().set("numberFormat", "#'% Humi'");

      // Create axis and its renderer
      // https://www.amcharts.com/docs/v5/charts/radar-chart/gauge-charts/#Axes
      var axisRenderer = am5radar.AxisRendererCircular.new(root, {
        innerRadius: -40
      });

      axisRenderer.grid.template.setAll({
        stroke: root.interfaceColors.get("background"),
        visible: true,
        strokeOpacity: 0.8
      });

      var xAxis = chart.xAxes.push(
        am5xy.ValueAxis.new(root, {
          maxDeviation: 0,
          min: 0,
          max: 100,
          strictMinMax: true,
          renderer: axisRenderer
        })
      );

      // Add clock hand
      // https://www.amcharts.com/docs/v5/charts/radar-chart/gauge-charts/#Clock_hands
      var axisDataItem = xAxis.makeDataItem({});

      var clockHand = am5radar.ClockHand.new(root, {
        pinRadius: 50,
        radius: am5.percent(100),
        innerRadius: 50,
        bottomWidth: 0,
        topWidth: 0
      });

      clockHand.pin.setAll({
        fillOpacity: 0,
        strokeOpacity: 0.5,
        stroke: am5.color(0x000000),
        strokeWidth: 1,
        strokeDasharray: [2, 2]
      });
      clockHand.hand.setAll({
        fillOpacity: 0,
        strokeOpacity: 0.5,
        stroke: am5.color(0x000000),
        strokeWidth: 0.5
      });

      var bullet = axisDataItem.set(
        "bullet",
        am5xy.AxisBullet.new(root, {
          sprite: clockHand
        })
      );

      xAxis.createAxisRange(axisDataItem);

      var label = chart.radarContainer.children.push(
        am5.Label.new(root, {
          centerX: am5.percent(50),
          textAlign: "center",
          centerY: am5.percent(50),
          fontSize: "1.5em"
        })
      );

      axisDataItem.set("value", 0);
      bullet.get("sprite").on("rotation", function () {
        var value = axisDataItem.get("value");
        label.set("text", Math.round(value).toString() + "%");
      });

      setInterval(function () {
        var value = 40;

        axisDataItem.animate({
          key: "value",
          to: value,
          duration: 500,
          easing: am5.ease.out(am5.ease.cubic)
        });

        axisRange0.animate({
          key: "endValue",
          to: value,
          duration: 500,
          easing: am5.ease.out(am5.ease.cubic)
        });

        axisRange1.animate({
          key: "value",
          to: value,
          duration: 500,
          easing: am5.ease.out(am5.ease.cubic)
        });
      }, 2000);

      chart.bulletsContainer.set("mask", undefined);

      var colorSet = am5.ColorSet.new(root, {});

      var axisRange0 = xAxis.createAxisRange(
        xAxis.makeDataItem({
          above: true,
          value: 0,
          endValue: 0
        })
      );

      axisRange0.get("axisFill").setAll({
        visible: true,
        fill: colorSet.getIndex(0)
      });

      axisRange0.get("label").setAll({
        forceHidden: true
      });

      var axisRange1 = xAxis.createAxisRange(
        xAxis.makeDataItem({
          above: true,
          value: 100,
          endValue: 100
        })
      );

      axisRange1.get("axisFill").setAll({
        visible: true,
        fill: colorSet.getIndex(4)
      });

      axisRange1.get("label").setAll({
        forceHidden: true
      });

      // Make stuff animate on load
      chart.appear(1000, 100);

    });

    // for alert MQTT server  
    let Alert = () => {
      alert("MQTT Broker Server has connected.....")
    }
  </script>
  <main class="entier-container">
    <nav class="nav">
      <h1>MQTT Protocol</h1>
      <button type="button" id="flip">Code Panel</button>
    </nav>
    <div class="container">
      <div class="leftcont">
        <img id="ifimg" src="./src/images/dht_off.gif" alt="interfacing" />
        <img id="ifimg2" src="./src/images/dht_on.gif" alt="interfacing" style="display: none;" />
        <div class="code-head startStop">
          <!-- <h2 id="openPopup" style="text-decoration: none; width:auto;">Open MQTT Connection</h2> -->
          <h2 id="pushbuttonPower" onclick="changePower();">Start Simulation</h2>
          
          <a href="#dash" style="text-decoration: none; width:auto;">
            <h2 id="MQTTDashboard">MQTT Dashboard</h2>
          </a>
        </div>
      </div>

      <textarea readonly cols="30" rows="10" type="text" id="textBox" placeholder="insert the code"></textarea>
    </div>
  </main>
<!-- MQTT popup -->
  <div id="mqttPopup" class="popup">
    <div class="popup-content">
        <span class="close">&times;</span>
        <h2>MQTT Connection</h2>
        <div class="MQtt-container">

            <div class="connection-details">
                <label for="name">Name</label>
                <input type="text" id="name" value="MQTT Server" placeholder="Enter the Name">
                <label for="validate" >Validate Certificate</label>
                <input type="checkbox" checked id="validate">
                <label for="encryption">Encryption (TLS)</label>
                <input type="checkbox" checked id="encryption">
            </div>
            <div class="connection-details">
                <label for="protocol">Protocol</label>
                <select id="protocol">
                    <option value="mqtt://">mqtt://</option>
                    <option value="http://">http://</option>
                </select>
                <label for="host">Host</label>
                <input type="text" id="host" value="Localhost" placeholder="Enter host">
                <label for="port">Port</label>
                <input type="number" id="port" value="8080">
            </div>

            <div class="connection-details">
                <label for="username">Username</label>
                <input type="text" value="MQTTserver" id="username" placeholder="Username">
                <label for="password">Password</label>
                <input type="password" value="MQtt123" id="password" placeholder="Password">
            </div>
        </div>


        <div class="buttons">
            <!-- <button id="delete">DELETE</button>
            <button id="advanced">ADVANCED</button> -->
            <button id="save">SAVE</button>
            <button class="connect">CONNECT</button>
        </div>
        <!-- </div> -->
    </div>
</div>
<!-- ****** -->
  <main id="dash" class="dash">
    <div class="top">
      <div class="chartbox">
        <div class="parameter"
          style="background-color: white; width: 36.5%; height:260px; margin:5px; border-radius:10px; display:flex; justify-content:center; flex-direction:column; align-items:center">
          <i class="fa-solid fa-temperature-low fa-fade"></i>
          <h1 style="margin-left:5px;">Temperature: 24 </h1>
        </div>
        <div class="parameter"
          style="background-color: white; width: 36.5%; height:260px; margin:5px; border-radius:10px; display:flex; justify-content:center; flex-direction:column; align-items:center">
          <i class="fa-solid fa-droplet fa-fade"></i>
          <h1 style="margin-left:5px;">Humidity: 40</h1>
        </div>
        <div  id="gauge2div" class="gauge">
        </div>
      </div>
      <div class="bottum">
        <div id="chartdiv2" class="temp2"></div>
        <div id="chartdiv" class="temp"></div>
        <div id="gaugediv" class="gauge2"></div>
      </div>
    </div>
  </main>
  <script>
    // for insert code
    function insertled() {
      var serv = (document.getElementById(
        "textBox"
      ).value = `#include <WiFi.h>
#include <PubSubClient.h>
#include "DHT.h"

// Replace with your network credentials
const char* ssid = "wifi1234";
const char* password = "12345678";

// Replace with your MQTT broker credentials
const char* mqtt_server = "mqtt.thingspeak.com"; // or any MQTT broker
const char* mqtt_user = "MQTTserver";
const char* mqtt_password = "MQtt123";
String apiKey = "your_API_KEY";

// ThingSpeak MQTT topic
String topic = "channels/YOUR_CHANNEL_ID/publish/" + apiKey;

// DHT11 sensor configuration
#define DHTPIN 4  // Digital pin connected to the DHT11 sensor
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

WiFiClient espClient;
PubSubClient client(espClient);

void setup_wifi() {
  delay(10);
  Serial.println();
  Serial.print("Connecting to ");
  Serial.println(ssid);

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println();
  Serial.println("WiFi connected");
}

void reconnect() {
  while (!client.connected()) {
    Serial.print("Attempting MQTT connection...");
    if (client.connect("ESP32Client", mqtt_user, mqtt_password)) {
      Serial.println("connected");
    } else {
      Serial.print("failed, rc=");
      Serial.print(client.state());
      Serial.println(" try again in 5 seconds");
      delay(5000);
    }
  }
}

void setup() {
  Serial.begin(115200);
  setup_wifi();
  client.setServer(mqtt_server, 1883);
  dht.begin();
}

void loop() {
  if (!client.connected()) {
    reconnect();
  }
  client.loop();

  float temperature = dht.readTemperature();
  float humidity = dht.readHumidity();

  if (isnan(temperature) || isnan(humidity)) {
    Serial.println("Failed to read from DHT sensor!");
    return;
  }

  String payload = "field1=" + String(temperature) + "&field2=" + String(humidity);
  Serial.print("Publishing data: ");
  Serial.println(payload);

  if (client.publish(topic.c_str(), payload.c_str())) {
    Serial.println("Data sent to ThingSpeak via MQTT");
  } else {
    Serial.println("Error sending data to ThingSpeak");
  }

  // ThingSpeak allows updates every 15 seconds
  delay(15000);
}

`);
    }
    insertled();
  </script>

  <script type="text/javascript" src="src/js/main.js"></script>
  <script src="./src/js/chart.js"></script>
  <script src="./src/js/gauge2.js"></script>
  <script src="./src/js/chart2.js"></script>
  <script src="./script.js"></script>
</body>

</html>